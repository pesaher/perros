<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Cheniles üêæ</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f7f7f7;
      margin: 2em;
      color: #333;
    }
    @media (prefers-color-scheme: dark) {
      body {
        background: #1a1a1a;
        color: #e0e0e0;
      }
    }
    
    h1 {
      text-align: center;
      margin-bottom: 1.5em;
    }
    
    #botones {
      text-align: center;
      margin-bottom: 1.5em;
      display: flex;
      justify-content: center;
      gap: 1em;
    }
    
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 0.6em 1.2em;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
    }
    
    button:hover {
      background: #43A047;
    }
    
    #contenedor {
      display: flex;
      flex-wrap: wrap;
      gap: 1em;
      justify-content: center;
    }
    
    .chenil {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      width: 230px;
      padding: 1em;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      transition: 0.2s;
    }
    
    @media (prefers-color-scheme: dark) {
      .chenil {
        background: #2d2d2d;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      }
    }
    
    .chenil:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    
    @media (prefers-color-scheme: dark) {
      .chenil:hover {
        box-shadow: 0 4px 10px rgba(0,0,0,0.5);
      }
    }
    
    .titulo {
      font-weight: 700;
      text-align: center;
      margin-bottom: 0.7em;
      font-size: 1.1em;
      color: #333;
      text-transform: capitalize;
    }
    
    @media (prefers-color-scheme: dark) {
      .titulo {
        color: #e0e0e0;
      }
    }
    
    .contenedor-marcos {
      display: flex;
      flex-direction: column;
      gap: 0.5em;
      min-height: 2em;
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 0.6em;
      position: relative;
      transition: background 0.3s;
    }
    
    @media (prefers-color-scheme: dark) {
      .contenedor-marcos {
        border-color: #555;
      }
    }
    
    .contenedor-marcos.vacio {
      background: #eee;
    }
    
    @media (prefers-color-scheme: dark) {
      .contenedor-marcos.vacio {
        background: #3a3a3a;
      }
    }
    
    .mensaje-vacio {
      color: #888;
      font-style: italic;
      text-align: center;
      font-size: 0.9em;
      pointer-events: none;
    }
    
    @media (prefers-color-scheme: dark) {
      .mensaje-vacio {
        color: #aaa;
      }
    }
    
    .marco {
      padding: 0.5em 0.6em;
      border-radius: 6px;
      cursor: grab;
      text-align: center;
      user-select: none;
      font-weight: bold;
      font-size: 1.05em;
      text-transform: uppercase;
      color: #333;
      /* Forzar que el color de texto sea oscuro para buena legibilidad */
      color: #000 !important;
    }
    
    .marco:active {
      cursor: grabbing;
    }
    
    /* Estilos para el modo clickable */
    .marco.clickable {
      cursor: pointer;
    }
    
    .marco.clickable:hover {
      opacity: 0.8;
      transform: scale(1.02);
      transition: transform 0.2s;
    }
    
    /* Botones flotantes */
    .botones-flotantes {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 1000;
    }
    
    .boton-flotante {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2em;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      transition: all 0.3s;
      /* Forzar colores espec√≠ficos que no cambien con el modo oscuro */
      background: #2196F3 !important;
      color: white !important;
    }
    
    .boton-flotante:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    
    .boton-reordenar {
      background: #2196F3;
      color: white;
    }
    
    .boton-guardar {
      background: #4CAF50 !important;
      color: white !important;
    }
    
    .boton-cancelar {
      background: #f44336 !important;
      color: white !important;
    }
    
    /* Estado deshabilitado para sortable */
    .sortable-disabled .marco {
      cursor: default !important;
    }
    
    .sortable-disabled .marco:active {
      cursor: default !important;
    }
  </style>
</head>
<body>
  <h1>Cheniles üêæ</h1>
  <div id="botones">
    <button id="actualizar">üíæ</button>
  </div>
  <div id="contenedor"></div>

  <div class="botones-flotantes" id="botonesFlotantes">
    <button class="boton-flotante boton-reordenar" id="btnReordenar">‚ÜïÔ∏è</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <script>
    // Variables globales
    let datos = {};
    let sortableInstances = [];
    let modoReordenar = false;
    let datosOriginales = {}; // Para guardar el estado original al cancelar

    function urlSinCache() {
      const base = 'https://raw.githubusercontent.com/pesaher/perros/refs/heads/main/archivos/cheniles.json';
      return base + '?v=' + Date.now(); // fuerza a saltar la cach√©
    }

    async function cargar() {
      const resp = await fetch(urlSinCache());
      datos = await resp.json();

      const guardado = localStorage.getItem('chenilesDrag');
      if (guardado) datos = JSON.parse(guardado);

      pintar();
    }

    // Colores pastel agradables basados en el nombre - MANTENIENDO COLORES ORIGINALES
    function colorPastel(nombre) {
      let hash = 0;
      for (let i = 0; i < nombre.length; i++) {
        hash = nombre.charCodeAt(i) + ((hash << 5) - hash);
      }
      const h = hash % 360;
      const s = 65 + (hash % 10);
      const l = 85;
      return `hsl(${h}, ${s}%, ${l}%)`;
    }

    // Formatear nombres de chenil (may√∫scula inicial + espacio antes del n√∫mero)
    function formatearNombreChenil(nombre) {
      return nombre.replace(/([a-zA-Z]+)(\d+)/, (_, letras, num) =>
        letras.charAt(0).toUpperCase() + letras.slice(1).toLowerCase() + ' ' + num
      );
    }

    function pintar() {
      const contenedor = document.getElementById('contenedor');
      contenedor.innerHTML = '';

      Object.entries(datos).forEach(([chenil, perros]) => {
        const caja = document.createElement('div');
        caja.className = 'chenil';

        const titulo = document.createElement('div');
        titulo.className = 'titulo';
        titulo.textContent = formatearNombreChenil(chenil);
        caja.appendChild(titulo);

        const zona = document.createElement('div');
        zona.className = 'contenedor-marcos';
        zona.dataset.chenil = chenil;

        if (perros.length === 0 || perros.every(n => !n.trim())) {
          zona.classList.add('vacio');
          const vacio = document.createElement('div');
          vacio.className = 'mensaje-vacio';
          vacio.textContent = '(vac√≠o)';
          zona.appendChild(vacio);
        } else {
          perros.forEach(nombre => {
            if (nombre && nombre.trim() !== '') {
              const marco = document.createElement('div');
              marco.className = 'marco clickable';
              marco.textContent = nombre;
              marco.style.backgroundColor = colorPastel(nombre);
              
              // Agregar evento de click para los nombres
              marco.addEventListener('click', () => {
                if (!modoReordenar) {
                  alert(`Has hecho click en: ${nombre}`);
                  // Aqu√≠ puedes agregar la funcionalidad que quieras al hacer click
                }
              });
              
              zona.appendChild(marco);
            }
          });
        }

        caja.appendChild(zona);
        contenedor.appendChild(caja);

        // Crear instancia de Sortable pero deshabilitada inicialmente
        const sortable = new Sortable(zona, {
          group: 'cheniles',
          animation: 150,
          disabled: true, // Deshabilitado por defecto
          onEnd: () => {
            limpiarVacios();
            actualizarDatos();
          }
        });
        
        sortableInstances.push(sortable);
      });
    }

    function activarModoReordenar() {
      modoReordenar = true;
      
      // Guardar estado original para posible cancelaci√≥n
      datosOriginales = JSON.parse(JSON.stringify(datos));
      
      // Activar todas las instancias de Sortable
      sortableInstances.forEach(sortable => {
        sortable.option("disabled", false);
      });
      
      // Cambiar cursores y clases
      document.querySelectorAll('.marco').forEach(marco => {
        marco.classList.remove('clickable');
        marco.style.cursor = 'grab';
      });
      
      // Actualizar botones flotantes
      const botonesFlotantes = document.getElementById('botonesFlotantes');
      botonesFlotantes.innerHTML = `
        <button class="boton-flotante boton-guardar" id="btnGuardar">‚úì</button>
        <button class="boton-flotante boton-cancelar" id="btnCancelar">‚úó</button>
      `;
      
      // Agregar eventos a los nuevos botones
      document.getElementById('btnGuardar').addEventListener('click', desactivarModoReordenar);
      document.getElementById('btnCancelar').addEventListener('click', cancelarReordenar);
    }

    function desactivarModoReordenar() {
      modoReordenar = false;
      
      // Desactivar todas las instancias de Sortable
      sortableInstances.forEach(sortable => {
        sortable.option("disabled", true);
      });
      
      // Restaurar cursores y clases
      document.querySelectorAll('.marco').forEach(marco => {
        marco.classList.add('clickable');
        marco.style.cursor = 'pointer';
      });
      
      // Actualizar botones flotantes
      const botonesFlotantes = document.getElementById('botonesFlotantes');
      botonesFlotantes.innerHTML = `
        <button class="boton-flotante boton-reordenar" id="btnReordenar">‚ÜïÔ∏è</button>
      `;
      
      // Agregar evento al bot√≥n de reordenar
      document.getElementById('btnReordenar').addEventListener('click', activarModoReordenar);
    }

    function cancelarReordenar() {
      // Restaurar datos originales
      datos = JSON.parse(JSON.stringify(datosOriginales));
      
      // Volver a pintar con los datos originales
      pintar();
      
      // Desactivar modo reordenar
      desactivarModoReordenar();
    }

    function limpiarVacios() {
      document.querySelectorAll('.contenedor-marcos').forEach(zona => {
        const marcos = zona.querySelectorAll('.marco');
        const vacio = zona.querySelector('.mensaje-vacio');
        if (marcos.length === 0) {
          if (!vacio) {
            zona.classList.add('vacio');
            const nuevo = document.createElement('div');
            nuevo.className = 'mensaje-vacio';
            nuevo.textContent = '(vac√≠o)';
            zona.appendChild(nuevo);
          }
        } else {
          zona.classList.remove('vacio');
          if (vacio) vacio.remove();
        }
      });
    }

    function actualizarDatos() {
      const nuevo = {};
      document.querySelectorAll('.contenedor-marcos').forEach(zona => {
        const chenil = zona.dataset.chenil;
        const perros = Array.from(zona.querySelectorAll('.marco')).map(m => m.textContent);
        nuevo[chenil] = perros.length ? perros : [""];
      });
      datos = nuevo;
      localStorage.setItem('chenilesDrag', JSON.stringify(datos));
    }

    async function pushToGithub() {
      const resp = await fetch('/.netlify/functions/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(datos)
      });
      const result = await resp.json();
      if (resp.ok && result.ok) {
        alert('‚úÖ Guardado correctamente');
      } else {
        alert('‚ùå Error: ' + (result.error || 'Desconocido'));
      }
    }

    // Inicializaci√≥n
    document.getElementById('actualizar').addEventListener('click', pushToGithub);
    document.getElementById('btnReordenar').addEventListener('click', activarModoReordenar);

    cargar();
  </script>
</body>
</html>
