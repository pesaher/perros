<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cheniles</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f7f7f7;
      margin: 1em;
      color: #333;
      font-size: 16px;
    }
    @media (prefers-color-scheme: dark) {
      body {
        background: #1a1a1a;
        color: #e0e0e0;
      }
    }
    
    @media (max-width: 768px) {
      body {
        margin: 0.5em;
        font-size: 14px;
      }
    }
    
    #contenedor {
      display: flex;
      flex-wrap: wrap;
      gap: 1em;
      justify-content: center;
    }
    
    .chenil {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      width: 230px;
      padding: 1em;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      transition: 0.2s;
    }
    
    @media (prefers-color-scheme: dark) {
      .chenil {
        background: #2d2d2d;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      }
    }
    
    @media (max-width: 768px) {
      .chenil {
        width: calc(50% - 1em);
        min-width: 140px;
        padding: 0.8em;
      }
    }
    
    @media (max-width: 480px) {
      .chenil {
        width: 100%;
        min-width: auto;
      }
    }
    
    .chenil:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    
    @media (prefers-color-scheme: dark) {
      .chenil:hover {
        box-shadow: 0 4px 10px rgba(0,0,0,0.5);
      }
    }
    
    .titulo {
      font-weight: 700;
      text-align: center;
      margin-bottom: 0.7em;
      font-size: 1.1em;
      color: #333;
      text-transform: capitalize;
    }
    
    @media (prefers-color-scheme: dark) {
      .titulo {
        color: #e0e0e0;
      }
    }
    
    .contenedor-marcos {
      display: flex;
      flex-direction: column;
      gap: 0.5em;
      min-height: 2em;
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 0.6em;
      position: relative;
      transition: background 0.3s;
    }
    
    @media (prefers-color-scheme: dark) {
      .contenedor-marcos {
        border-color: #555;
      }
    }
    
    .contenedor-marcos.vacio {
      background: #eee;
    }
    
    @media (prefers-color-scheme: dark) {
      .contenedor-marcos.vacio {
        background: #3a3a3a;
      }
    }
    
    .mensaje-vacio {
      color: #888;
      font-style: italic;
      text-align: center;
      font-size: 0.9em;
      pointer-events: none;
    }
    
    @media (prefers-color-scheme: dark) {
      .mensaje-vacio {
        color: #aaa;
      }
    }
    
    .marco {
      padding: 0.5em 0.6em;
      border-radius: 6px;
      cursor: grab;
      text-align: center;
      user-select: none;
      font-weight: bold;
      font-size: 1.05em;
      text-transform: uppercase;
      color: #333;
      /* Forzar que el color de texto sea oscuro para buena legibilidad */
      color: #000 !important;
    }
    
    @media (max-width: 768px) {
      .marco {
        padding: 0.4em 0.5em;
        font-size: 0.95em;
      }
    }
    
    .marco:active {
      cursor: grabbing;
    }
    
    /* Estilos para el modo clickable */
    .marco.clickable {
      cursor: pointer;
    }
    
    .marco.clickable:hover {
      opacity: 0.8;
      transform: scale(1.02);
      transition: transform 0.2s;
    }
    
    /* Botones flotantes */
    .botones-flotantes {
      position: fixed;
      top: 10px;
      right: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 1000;
    }
    
    @media (max-width: 768px) {
      .botones-flotantes {
        top: 5px;
        right: 5px;
      }
    }
    
    .boton-flotante {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2em;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      transition: all 0.3s;
      /* Forzar colores espec√≠ficos que no cambien con el modo oscuro */
      background: #2196F3 !important;
      color: white !important;
    }
    
    @media (max-width: 768px) {
      .boton-flotante {
        width: 45px;
        height: 45px;
        font-size: 1.1em;
      }
    }
    
    .boton-flotante:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    
    .boton-reordenar {
      background: #2196F3;
      color: white;
    }
    
    .boton-filtrar {
      background: #9C27B0 !important;
      color: white !important;
    }
    
    .boton-guardar {
      background: #4CAF50 !important;
      color: white !important;
    }
    
    .boton-cancelar {
      background: #f44336 !important;
      color: white !important;
    }
    
    /* Estado deshabilitado para sortable */
    .sortable-disabled .marco {
      cursor: default !important;
    }
    
    .sortable-disabled .marco:active {
      cursor: default !important;
    }
    
    /* Modal de filtros */
    .modal-filtros {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    
    .contenido-modal {
      background: white;
      border-radius: 10px;
      padding: 2em;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    @media (prefers-color-scheme: dark) {
      .contenido-modal {
        background: #2d2d2d;
      }
    }
    
    .grupo-filtros {
      margin-bottom: 1.5em;
    }
    
    .titulo-filtro {
      font-weight: bold;
      margin-bottom: 0.5em;
      color: #333;
    }
    
    @media (prefers-color-scheme: dark) {
      .titulo-filtro {
        color: #e0e0e0;
      }
    }
    
    .opciones-filtro {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5em;
    }
    
    .opcion-filtro {
      background: #f0f0f0;
      border: 2px solid #ddd;
      border-radius: 20px;
      padding: 0.5em 1em;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    @media (prefers-color-scheme: dark) {
      .opcion-filtro {
        background: #3a3a3a;
        border-color: #555;
        color: #e0e0e0;
      }
    }
    
    .opcion-filtro.activa {
      background: #2196F3;
      color: white;
      border-color: #2196F3;
    }
    
    .opcion-filtro:hover {
      transform: scale(1.05);
    }
    
    .botones-filtros {
      display: flex;
      gap: 1em;
      margin-top: 1.5em;
    }
    
    .boton-filtro {
      flex: 1;
      padding: 0.7em;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
    }
    
    .boton-aplicar {
      background: #4CAF50;
      color: white;
    }
    
    .boton-limpiar {
      background: #ff9800;
      color: white;
    }
    
    .boton-cerrar {
      background: #f44336;
      color: white;
    }
    
    /* Estilos para perros filtrados */
    .marco.filtrado {
      opacity: 0.3;
    }
    
    .marco.cumple-filtro {
      opacity: 1;
      border: 2px solid #4CAF50;
    }
  </style>
</head>
<body>
  <div id="contenedor"></div>

  <div class="botones-flotantes" id="botonesFlotantes">
    <button class="boton-flotante boton-reordenar" id="btnReordenar">‚ÜïÔ∏è</button>
    <button class="boton-flotante boton-filtrar" id="btnFiltrar">üîç</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <script>
    // Variables globales
    let datos = {};
    let sortableInstances = [];
    let modoReordenar = false;
    let datosOriginales = {};
    let datosCompletosPerros = {}; // Almacenar√° todos los datos de cada perro
    let filtrosActivos = {};

    function urlSinCache() {
      const base = 'https://raw.githubusercontent.com/pesaher/perros/refs/heads/main/archivos/cheniles.json';
      return base + '?v=' + Date.now();
    }

    async function cargar() {
      const resp = await fetch(urlSinCache());
      datos = await resp.json();
      await cargarDatosCompletosPerros();
      pintar();
    }

    // Cargar datos completos de todos los perros para el filtrado
    async function cargarDatosCompletosPerros() {
      datosCompletosPerros = {};
      const nombresPerros = new Set();
      
      // Recoger todos los nombres √∫nicos de perros
      Object.values(datos).forEach(perros => {
        perros.forEach(nombre => {
          if (nombre && nombre.trim() !== '') {
            nombresPerros.add(nombre);
          }
        });
      });
      
      // Cargar datos de cada perro
      for (let nombre of nombresPerros) {
        try {
          const url = `https://raw.githubusercontent.com/pesaher/perros/refs/heads/main/archivos/perros/${encodeURIComponent(nombre)}.json?v=${Date.now()}`;
          const respuesta = await fetch(url);
          if (respuesta.ok) {
            const datosPerro = await respuesta.json();
            datosCompletosPerros[nombre] = datosPerro;
          }
        } catch (error) {
          console.warn(`No se pudieron cargar los datos de ${nombre}:`, error);
        }
      }
    }

    // Colores pastel agradables basados en el nombre - MANTENIENDO COLORES ORIGINALES
    function colorPastel(nombre) {
      let hash = 0;
      for (let i = 0; i < nombre.length; i++) {
        hash = nombre.charCodeAt(i) + ((hash << 5) - hash);
      }
      const h = hash % 360;
      const s = 65 + (hash % 10);
      const l = 85;
      return `hsl(${h}, ${s}%, ${l}%)`;
    }

    // Formatear nombres de chenil (may√∫scula inicial + espacio antes del n√∫mero)
    function formatearNombreChenil(nombre) {
      return nombre.replace(/([a-zA-Z]+)(\d+)/, (_, letras, num) =>
        letras.charAt(0).toUpperCase() + letras.slice(1).toLowerCase() + ' ' + num
      );
    }

    function pintar() {
      const contenedor = document.getElementById('contenedor');
      contenedor.innerHTML = '';

      Object.entries(datos).forEach(([chenil, perros]) => {
        const caja = document.createElement('div');
        caja.className = 'chenil';

        const titulo = document.createElement('div');
        titulo.className = 'titulo';
        titulo.textContent = formatearNombreChenil(chenil);
        caja.appendChild(titulo);

        const zona = document.createElement('div');
        zona.className = 'contenedor-marcos';
        zona.dataset.chenil = chenil;

        if (perros.length === 0 || perros.every(n => !n.trim())) {
          zona.classList.add('vacio');
          const vacio = document.createElement('div');
          vacio.className = 'mensaje-vacio';
          vacio.textContent = '(vac√≠o)';
          zona.appendChild(vacio);
        } else {
          perros.forEach(nombreOriginal => {
            if (nombreOriginal && nombreOriginal.trim() !== '') {
              const marco = document.createElement('div');
              marco.className = 'marco clickable';
              
              // Guardar el nombre original en un atributo data
              marco.dataset.nombreOriginal = nombreOriginal;
              
              // Mostrar en uppercase
              marco.textContent = nombreOriginal.toUpperCase();
              
              marco.style.backgroundColor = colorPastel(nombreOriginal);
              
              // Aplicar filtros si existen
              if (Object.keys(filtrosActivos).length > 0) {
                const cumpleFiltro = aplicarFiltros(nombreOriginal);
                if (!cumpleFiltro) {
                  marco.classList.add('filtrado');
                } else {
                  marco.classList.add('cumple-filtro');
                }
              }
              
              // Agregar evento de click para los nombres
              marco.addEventListener('click', () => {
                if (!modoReordenar) {
                  // Usar el nombre original (camelCase) para la redirecci√≥n
                  window.location.href = `perro.html?nombre=${encodeURIComponent(nombreOriginal)}`;
                }
              });
              
              zona.appendChild(marco);
            }
          });
        }

        caja.appendChild(zona);
        contenedor.appendChild(caja);

        // Crear instancia de Sortable pero deshabilitada inicialmente
        const sortable = new Sortable(zona, {
          group: 'cheniles',
          animation: 150,
          disabled: true, // Deshabilitado por defecto
          onEnd: () => {
            limpiarVacios();
            actualizarDatos();
          }
        });
        
        sortableInstances.push(sortable);
      });
    }

    // Funci√≥n para aplicar filtros a un perro
    function aplicarFiltros(nombrePerro) {
      const datosPerro = datosCompletosPerros[nombrePerro];
      if (!datosPerro) return false; // Si no tenemos datos, no mostrar
      
      for (const [filtro, valor] of Object.entries(filtrosActivos)) {
        if (valor === null || valor === undefined) continue;
        
        switch (filtro) {
          case 'reservado':
            if (datosPerro.reservado !== valor) return false;
            break;
          case 'macho':
            if (datosPerro.macho !== valor) return false;
            break;
          case 'leishmania':
            if (datosPerro.leishmania !== valor) return false;
            break;
          case 'sociableConPerros':
            if (datosPerro.sociableConPerros !== valor) return false;
            break;
          case 'sociableConPersonas':
            if (datosPerro.sociableConPersonas !== valor) return false;
            break;
          case 'paseo':
            if (datosPerro.paseo !== valor) return false;
            break;
        }
      }
      
      return true;
    }

    // Mostrar modal de filtros
    function mostrarModalFiltros() {
      const modal = document.createElement('div');
      modal.className = 'modal-filtros';
      modal.innerHTML = `
        <div class="contenido-modal">
          <h3>Filtrar Perros</h3>
          
          <div class="grupo-filtros">
            <div class="titulo-filtro">Estado</div>
            <div class="opciones-filtro">
              <div class="opcion-filtro ${filtrosActivos.reservado === null ? 'activa' : ''}" data-filtro="reservado" data-valor="null">üîì Disponible</div>
              <div class="opcion-filtro ${filtrosActivos.reservado === true ? 'activa' : ''}" data-filtro="reservado" data-valor="true">üîí Reservado</div>
              <div class="opcion-filtro ${filtrosActivos.reservado === false ? 'activa' : ''}" data-filtro="reservado" data-valor="false">üîí Adoptado</div>
            </div>
          </div>
          
          <div class="grupo-filtros">
            <div class="titulo-filtro">Sexo</div>
            <div class="opciones-filtro">
              <div class="opcion-filtro ${filtrosActivos.macho === true ? 'activa' : ''}" data-filtro="macho" data-valor="true">‚ôÇÔ∏è Macho</div>
              <div class="opcion-filtro ${filtrosActivos.macho === false ? 'activa' : ''}" data-filtro="macho" data-valor="false">‚ôÄÔ∏è Hembra</div>
            </div>
          </div>
          
          <div class="grupo-filtros">
            <div class="titulo-filtro">Leishmania</div>
            <div class="opciones-filtro">
              <div class="opcion-filtro ${filtrosActivos.leishmania === true ? 'activa' : ''}" data-filtro="leishmania" data-valor="true">‚úÖ S√≠</div>
              <div class="opcion-filtro ${filtrosActivos.leishmania === false ? 'activa' : ''}" data-filtro="leishmania" data-valor="false">‚ùå No</div>
            </div>
          </div>
          
          <div class="grupo-filtros">
            <div class="titulo-filtro">Sociable con Perros</div>
            <div class="opciones-filtro">
              <div class="opcion-filtro ${filtrosActivos.sociableConPerros === 0 ? 'activa' : ''}" data-filtro="sociableConPerros" data-valor="0">S√≠</div>
              <div class="opcion-filtro ${filtrosActivos.sociableConPerros === 1 ? 'activa' : ''}" data-filtro="sociableConPerros" data-valor="1">Selectivo</div>
              <div class="opcion-filtro ${filtrosActivos.sociableConPerros === 2 ? 'activa' : ''}" data-filtro="sociableConPerros" data-valor="2">No</div>
            </div>
          </div>
          
          <div class="grupo-filtros">
            <div class="titulo-filtro">Nivel de Paseo</div>
            <div class="opciones-filtro">
              <div class="opcion-filtro ${filtrosActivos.paseo === 0 ? 'activa' : ''}" data-filtro="paseo" data-valor="0">Pasea bien</div>
              <div class="opcion-filtro ${filtrosActivos.paseo === 1 ? 'activa' : ''}" data-filtro="paseo" data-valor="1">Miedo (gestionable)</div>
              <div class="opcion-filtro ${filtrosActivos.paseo === 2 ? 'activa' : ''}" data-filtro="paseo" data-valor="2">Miedo (bloqueo)</div>
              <div class="opcion-filtro ${filtrosActivos.paseo === 3 ? 'activa' : ''}" data-filtro="paseo" data-valor="3">Reactivo</div>
              <div class="opcion-filtro ${filtrosActivos.paseo === 4 ? 'activa' : ''}" data-filtro="paseo" data-valor="4">Tira</div>
            </div>
          </div>
          
          <div class="botones-filtros">
            <button class="boton-filtro boton-limpiar" id="btnLimpiarFiltros">üßπ Limpiar</button>
            <button class="boton-filtro boton-aplicar" id="btnAplicarFiltros">‚úÖ Aplicar</button>
            <button class="boton-filtro boton-cerrar" id="btnCerrarFiltros">‚úó Cerrar</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Event listeners para opciones de filtro
      modal.querySelectorAll('.opcion-filtro').forEach(opcion => {
        opcion.addEventListener('click', () => {
          const filtro = opcion.dataset.filtro;
          const valor = opcion.dataset.valor === 'null' ? null : 
                       opcion.dataset.valor === 'true' ? true :
                       opcion.dataset.valor === 'false' ? false :
                       !isNaN(opcion.dataset.valor) ? parseInt(opcion.dataset.valor) : opcion.dataset.valor;
          
          // Toggle: si ya est√° activo, desactivar; si no, activar
          if (filtrosActivos[filtro] === valor) {
            delete filtrosActivos[filtro];
            opcion.classList.remove('activa');
          } else {
            filtrosActivos[filtro] = valor;
            // Remover activo de otras opciones del mismo filtro
            modal.querySelectorAll(`.opcion-filtro[data-filtro="${filtro}"]`).forEach(o => {
              o.classList.remove('activa');
            });
            opcion.classList.add('activa');
          }
        });
      });
      
      // Event listeners para botones
      modal.querySelector('#btnAplicarFiltros').addEventListener('click', () => {
        pintar();
        document.body.removeChild(modal);
      });
      
      modal.querySelector('#btnLimpiarFiltros').addEventListener('click', () => {
        filtrosActivos = {};
        pintar();
        document.body.removeChild(modal);
      });
      
      modal.querySelector('#btnCerrarFiltros').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
      
      // Cerrar modal al hacer click fuera
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          document.body.removeChild(modal);
        }
      });
    }

    function activarModoReordenar() {
      modoReordenar = true;
      
      // Guardar estado original para posible cancelaci√≥n
      datosOriginales = JSON.parse(JSON.stringify(datos));
      
      // Activar todas las instancias de Sortable
      sortableInstances.forEach(sortable => {
        sortable.option("disabled", false);
      });
      
      // Cambiar cursores y clases
      document.querySelectorAll('.marco').forEach(marco => {
        marco.classList.remove('clickable');
        marco.style.cursor = 'grab';
      });
      
      // Actualizar botones flotantes
      const botonesFlotantes = document.getElementById('botonesFlotantes');
      botonesFlotantes.innerHTML = `
        <button class="boton-flotante boton-guardar" id="btnGuardar">‚úì</button>
        <button class="boton-flotante boton-cancelar" id="btnCancelar">‚úó</button>
      `;
      
      // Agregar eventos a los nuevos botones
      document.getElementById('btnGuardar').addEventListener('click', () => desactivarModoReordenar(true));
      document.getElementById('btnCancelar').addEventListener('click', cancelarReordenar);
    }

    function desactivarModoReordenar(guardarEnGitHub = false) {
      modoReordenar = false;
      
      // Desactivar todas las instancias de Sortable
      sortableInstances.forEach(sortable => {
        sortable.option("disabled", true);
      });
      
      // Restaurar cursores y clases
      document.querySelectorAll('.marco').forEach(marco => {
        marco.classList.add('clickable');
        marco.style.cursor = 'pointer';
      });
      
      // Actualizar botones flotantes
      const botonesFlotantes = document.getElementById('botonesFlotantes');
      botonesFlotantes.innerHTML = `
        <button class="boton-flotante boton-reordenar" id="btnReordenar">‚ÜïÔ∏è</button>
        <button class="boton-flotante boton-filtrar" id="btnFiltrar">üîç</button>
      `;
      
      // Agregar eventos a los botones
      document.getElementById('btnReordenar').addEventListener('click', activarModoReordenar);
      document.getElementById('btnFiltrar').addEventListener('click', mostrarModalFiltros);
      
      // Guardar cambios en GitHub solo si se especifica
      if (guardarEnGitHub) {
        pushToGithub();
      }
    }
    
    function cancelarReordenar() {
      // Restaurar datos originales
      datos = JSON.parse(JSON.stringify(datosOriginales));
      
      // Limpiar instancias de Sortable antes de repintar
      sortableInstances = [];
      
      // Volver a pintar con los datos originales
      pintar();
      
      // Desactivar modo reordenar sin guardar
      desactivarModoReordenar(false);
    }

    function limpiarVacios() {
      document.querySelectorAll('.contenedor-marcos').forEach(zona => {
        const marcos = zona.querySelectorAll('.marco');
        const vacio = zona.querySelector('.mensaje-vacio');
        if (marcos.length === 0) {
          if (!vacio) {
            zona.classList.add('vacio');
            const nuevo = document.createElement('div');
            nuevo.className = 'mensaje-vacio';
            nuevo.textContent = '(vac√≠o)';
            zona.appendChild(nuevo);
          }
        } else {
          zona.classList.remove('vacio');
          if (vacio) vacio.remove();
        }
      });
    }

    function actualizarDatos() {
      const nuevo = {};
      document.querySelectorAll('.contenedor-marcos').forEach(zona => {
        const chenil = zona.dataset.chenil;
        const perros = Array.from(zona.querySelectorAll('.marco')).map(m => m.dataset.nombreOriginal);
        nuevo[chenil] = perros.length ? perros : [""];
      });
      datos = nuevo;
      localStorage.setItem('chenilesDrag', JSON.stringify(datos));
    }

    async function pushToGithub() {
      const resp = await fetch('/.netlify/functions/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(datos)
      });
      const result = await resp.json();
      if (resp.ok && result.ok) {
        alert('‚úÖ Guardado correctamente');
      } else {
        alert('‚ùå Error: ' + (result.error || 'Desconocido'));
      }
    }

    // Inicializaci√≥n
    document.getElementById('btnReordenar').addEventListener('click', activarModoReordenar);
    document.getElementById('btnFiltrar').addEventListener('click', mostrarModalFiltros);

    cargar();
  </script>
</body>
</html>
