<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Cheniles üêæ</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f7f7f7;
      margin: 2em;
    }
    h1 {
      text-align: center;
      margin-bottom: 1.5em;
    }
    #botones {
      text-align: center;
      margin-bottom: 1.5em;
      display: flex;
      justify-content: center;
      gap: 1em;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 0.6em 1.2em;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
    }
    button:hover {
      background: #43A047;
    }
    #contenedor {
      display: flex;
      flex-wrap: wrap;
      gap: 1em;
      justify-content: center;
    }
    .chenil {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      width: 230px;
      padding: 1em;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      transition: 0.2s;
    }
    .chenil:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    .titulo {
      font-weight: 700;
      text-align: center;
      margin-bottom: 0.7em;
      font-size: 1.1em;
      color: #333;
      text-transform: capitalize;
    }
    .contenedor-marcos {
      display: flex;
      flex-direction: column;
      gap: 0.5em;
      min-height: 2em;
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 0.6em;
      position: relative;
      transition: background 0.3s;
    }
    .contenedor-marcos.vacio {
      background: #eee;
    }
    .mensaje-vacio {
      color: #888;
      font-style: italic;
      text-align: center;
      font-size: 0.9em;
      pointer-events: none;
    }
    .marco {
      padding: 0.5em 0.6em;
      border-radius: 6px;
      cursor: grab;
      text-align: center;
      user-select: none;
      font-weight: bold;
      font-size: 1.05em;
      text-transform: uppercase;
      color: #333;
    }
    .marco:active {
      cursor: grabbing;
    }
  </style>
</head>
<body>
  <h1>Cheniles üêæ</h1>
  <div id="botones">
    <button id="actualizar">Actualizar en GitHub</button>
    <button id="descargar">Descargar JSON</button>
  </div>
  <div id="contenedor"></div>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <script>
    function urlSinCache() {
      const base = 'https://raw.githubusercontent.com/pesaher/perros/refs/heads/main/archivos/cheniles.json';
      return base + '?v=' + Date.now(); // fuerza a saltar la cach√©
    }
    let datos = {};

    async function cargar() {
      const resp = await fetch(urlSinCache());
      datos = await resp.json();

      const guardado = localStorage.getItem('chenilesDrag');
      if (guardado) datos = JSON.parse(guardado);

      pintar();
    }

    // Colores pastel agradables basados en el nombre
    function colorPastel(nombre) {
      let hash = 0;
      for (let i = 0; i < nombre.length; i++) {
        hash = nombre.charCodeAt(i) + ((hash << 5) - hash);
      }
      const h = hash % 360;
      const s = 65 + (hash % 10);
      const l = 85;
      return `hsl(${h}, ${s}%, ${l}%)`;
    }

    // Formatear nombres de chenil (may√∫scula inicial + espacio antes del n√∫mero)
    function formatearNombreChenil(nombre) {
      return nombre.replace(/([a-zA-Z]+)(\d+)/, (_, letras, num) =>
        letras.charAt(0).toUpperCase() + letras.slice(1).toLowerCase() + ' ' + num
      );
    }

    function pintar() {
      const contenedor = document.getElementById('contenedor');
      contenedor.innerHTML = '';

      Object.entries(datos).forEach(([chenil, perros]) => {
        const caja = document.createElement('div');
        caja.className = 'chenil';

        const titulo = document.createElement('div');
        titulo.className = 'titulo';
        titulo.textContent = formatearNombreChenil(chenil);
        caja.appendChild(titulo);

        const zona = document.createElement('div');
        zona.className = 'contenedor-marcos';
        zona.dataset.chenil = chenil;

        if (perros.length === 0 || perros.every(n => !n.trim())) {
          zona.classList.add('vacio');
          const vacio = document.createElement('div');
          vacio.className = 'mensaje-vacio';
          vacio.textContent = '(vac√≠o)';
          zona.appendChild(vacio);
        } else {
          perros.forEach(nombre => {
            if (nombre && nombre.trim() !== '') {
              const marco = document.createElement('div');
              marco.className = 'marco';
              marco.textContent = nombre;
              marco.style.backgroundColor = colorPastel(nombre);
              zona.appendChild(marco);
            }
          });
        }

        caja.appendChild(zona);
        contenedor.appendChild(caja);

        new Sortable(zona, {
          group: 'cheniles',
          animation: 150,
          onEnd: () => {
            limpiarVacios();
            actualizarDatos();
          }
        });
      });
    }

    function limpiarVacios() {
      document.querySelectorAll('.contenedor-marcos').forEach(zona => {
        const marcos = zona.querySelectorAll('.marco');
        const vacio = zona.querySelector('.mensaje-vacio');
        if (marcos.length === 0) {
          if (!vacio) {
            zona.classList.add('vacio');
            const nuevo = document.createElement('div');
            nuevo.className = 'mensaje-vacio';
            nuevo.textContent = '(vac√≠o)';
            zona.appendChild(nuevo);
          }
        } else {
          zona.classList.remove('vacio');
          if (vacio) vacio.remove();
        }
      });
    }

    function actualizarDatos() {
      const nuevo = {};
      document.querySelectorAll('.contenedor-marcos').forEach(zona => {
        const chenil = zona.dataset.chenil;
        const perros = Array.from(zona.querySelectorAll('.marco')).map(m => m.textContent);
        nuevo[chenil] = perros.length ? perros : [""];
      });
      datos = nuevo;
      localStorage.setItem('chenilesDrag', JSON.stringify(datos));
    }

    function descargarJSON() {
      const blob = new Blob([JSON.stringify(datos, null, 2)], {type: 'application/json'});
      const enlace = document.createElement('a');
      enlace.href = URL.createObjectURL(blob);
      enlace.download = 'cheniles_actualizado.json';
      enlace.click();
    }

    async function pushToGithub() {
      const resp = await fetch('/.netlify/functions/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(datos)
      });
      const result = await resp.json();
      if (resp.ok && result.ok) {
        alert('‚úÖ Archivo actualizado en GitHub:\n' + result.commit);
      } else {
        alert('‚ùå Error: ' + (result.error || 'Desconocido'));
      }
    }

    document.getElementById('descargar').addEventListener('click', descargarJSON);
    document.getElementById('actualizar').addEventListener('click', pushToGithub);

    cargar();
  </script>
</body>
</html>
