<!DOCTYPE html>
<html>
<head>
  <title>Migrar TODO a Supabase</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; }
    input { width: 100%; padding: 10px; margin: 5px 0; box-sizing: border-box; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; font-size: 16px; }
    #log { background: #1e1e1e; color: #f0f0f0; padding: 15px; margin: 20px 0;
           height: 500px; overflow-y: auto; font-family: 'Courier New', monospace;
           border-radius: 5px; font-size: 14px; }
    .success { color: #4CAF50; }
    .error { color: #f44336; }
    .warning { color: #FF9800; }
    .info { color: #2196F3; }
    .stats { background: #2d2d2d; padding: 15px; border-radius: 5px; margin: 10px 0; }
    .progress-bar { width: 100%; background: #333; border-radius: 5px; margin: 10px 0; }
    .progress { height: 20px; background: #4CAF50; border-radius: 5px; width: 0%; transition: width 0.3s; }
  </style>
</head>
<body>
  <h1>üöÄ Migrar TODOS los perros a Supabase</h1>

  <div class="stats">
    <h3>1. Configurar Supabase</h3>
    <input id="url" placeholder="URL de Supabase (https://xxx.supabase.co)">
    <input id="key" placeholder="Anon Key">
    <button onclick="inicializar()">Conectar a Supabase</button>
    <div id="connectionStatus"></div>
  </div>

  <div class="stats">
    <h3>2. Buscar todos los perros</h3>
    <button onclick="buscarTodosPerros()" id="btnBuscar" disabled>üîç Buscar todos los perros en GitHub</button>
    <div id="perrosInfo"></div>
  </div>

  <div class="stats">
    <h3>3. Migrar Datos</h3>
    <button onclick="migrarTodo()" id="btnMigrar" disabled>üöÄ Migrar TODOS los perros</button>
    <button onclick="migrarSoloHu√©rfanos()" id="btnHu√©rfanos" disabled>üëª Migrar solo perros hu√©rfanos</button>
    <button onclick="limpiarTabla()" id="btnLimpiar" disabled style="background: #f44336; color: white;">üóëÔ∏è Limpiar tabla (peligroso)</button>

    <div class="progress-bar">
      <div class="progress" id="progressBar"></div>
    </div>
    <div id="progressText">Esperando...</div>
  </div>

  <div id="log"></div>

  <script>
    let supabase = null;
    let todosLosPerros = new Set();
    let perrosConChenil = {}; // { "LunaBella": "chenilA1", ... }
    const log = document.getElementById('log');

    function logMsg(mensaje, tipo = 'info') {
      const p = document.createElement('p');
      p.className = tipo;
      p.textContent = `[${new Date().toLocaleTimeString()}] ${mensaje}`;
      log.appendChild(p);
      log.scrollTop = log.scrollHeight;
    }

    function actualizarProgreso(actual, total) {
      const porcentaje = Math.round((actual / total) * 100);
      document.getElementById('progressBar').style.width = `${porcentaje}%`;
      document.getElementById('progressText').textContent =
        `${actual}/${total} (${porcentaje}%)`;
    }

    function inicializar() {
      const url = document.getElementById('url').value.trim();
      const key = document.getElementById('key').value.trim();

      if (!url || !key) {
        logMsg('‚ùå Faltan URL o Key', 'error');
        return;
      }

      supabase = window.supabase.createClient(url, key);

      // Probar conexi√≥n
      supabase.from('perros').select('count', { count: 'exact', head: true })
        .then(({ error }) => {
          if (error) {
            logMsg(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
            document.getElementById('connectionStatus').innerHTML =
              '<span style="color:red">‚ùå No se pudo conectar</span>';
          } else {
            logMsg('‚úÖ Conectado a Supabase correctamente', 'success');
            document.getElementById('connectionStatus').innerHTML =
              '<span style="color:green">‚úÖ Conectado</span>';

            document.getElementById('btnBuscar').disabled = false;
            document.getElementById('btnLimpiar').disabled = false;
          }
        });
    }

    async function buscarTodosPerros() {
      if (!supabase) {
        logMsg('‚ùå Primero conecta a Supabase', 'error');
        return;
      }

      logMsg('üîç Buscando TODOS los perros en GitHub...', 'info');

      try {
        // 1. Buscar perros en cheniles.json
        const chenilesResp = await fetch('https://raw.githubusercontent.com/pesaher/perros/main/archivos/cheniles.json');
        const estructura = await chenilesResp.json();

        // Extraer perros de cheniles
        Object.entries(estructura).forEach(([chenilId, perrosIds]) => {
          perrosIds.forEach(perroId => {
            if (perroId && perroId.trim() !== '') {
              todosLosPerros.add(perroId);
              perrosConChenil[perroId] = chenilId;
            }
          });
        });

        logMsg(`üìä Encontrados ${todosLosPerros.size} perros en cheniles`, 'info');

        // 2. Buscar archivos JSON directamente en la carpeta perros
        logMsg('üîç Buscando perros hu√©rfanos en GitHub...', 'info');

        // Intentar obtener lista de archivos del repositorio
        try {
          const repoUrl = 'https://api.github.com/repos/pesaher/perros/git/trees/main?recursive=1';
          const repoResp = await fetch(repoUrl);

          if (repoResp.ok) {
            const repoData = await repoResp.json();

            // Filtrar archivos JSON en la carpeta perros
            const archivosPerros = repoData.tree.filter(item =>
              item.path.startsWith('archivos/perros/') &&
              item.path.endsWith('.json') &&
              !item.path.endsWith('perro.json') // Excluir plantilla
            );

            // A√±adir perros que no estaban en cheniles
            archivosPerros.forEach(archivo => {
              const nombrePerro = archivo.path
                .replace('archivos/perros/', '')
                .replace('.json', '');

              if (!todosLosPerros.has(nombrePerro)) {
                todosLosPerros.add(nombrePerro);
                logMsg(`üëª Encontrado perro hu√©rfano: ${nombrePerro}`, 'warning');
              }
            });

            logMsg(`üìä Total: ${todosLosPerros.size} perros encontrados (${archivosPerros.length} archivos JSON)`, 'success');

          } else {
            // Fallback: si GitHub API falla, usar m√©todo alternativo
            logMsg('‚ö†Ô∏è GitHub API fall√≥, usando m√©todo alternativo...', 'warning');
            await buscarPerrosAlternativo();
          }

        } catch (error) {
          logMsg('‚ö†Ô∏è Error con GitHub API, usando m√©todo alternativo...', 'warning');
          await buscarPerrosAlternativo();
        }

        // Mostrar estad√≠sticas
        document.getElementById('perrosInfo').innerHTML = `
          <div style="margin-top: 10px;">
            <strong>üìä Estad√≠sticas:</strong><br>
            ‚Ä¢ Total perros encontrados: ${todosLosPerros.size}<br>
            ‚Ä¢ Con chenil asignado: ${Object.keys(perrosConChenil).length}<br>
            ‚Ä¢ Hu√©rfanos (sin chenil): ${todosLosPerros.size - Object.keys(perrosConChenil).length}
          </div>
        `;

        document.getElementById('btnMigrar').disabled = false;
        document.getElementById('btnHu√©rfanos').disabled = false;

      } catch (error) {
        logMsg(`‚ùå Error general: ${error.message}`, 'error');
      }
    }

    async function buscarPerrosAlternativo() {
      // M√©todo alternativo: intentar cargar algunos perros conocidos
      logMsg('üîÑ Usando m√©todo alternativo para buscar perros...', 'info');

      // Lista de perros comunes o conocidos (puedes a√±adir m√°s)
      const perrosConocidos = [
        'Luna', 'Max', 'Rex', 'Buddy', 'Rocky', 'Bailey', 'Daisy', 'Maggie',
        'Charlie', 'Lucy', 'Cooper', 'Sadie', 'Toby', 'Lola', 'Jack', 'Chloe'
      ];

      // Intentar cargar cada perro
      for (const nombre of perrosConocidos) {
        try {
          const url = `https://raw.githubusercontent.com/pesaher/perros/main/archivos/perros/${nombre}.json`;
          const respuesta = await fetch(url);

          if (respuesta.ok) {
            if (!todosLosPerros.has(nombre)) {
              todosLosPerros.add(nombre);
              logMsg(`‚úÖ Encontrado: ${nombre}`, 'success');
            }
          }
        } catch (e) {
          // Continuar con el siguiente
        }
      }

      logMsg(`üìä M√©todo alternativo: ${todosLosPerros.size} perros encontrados`, 'info');
    }

    async function migrarTodo() {
      if (!supabase || todosLosPerros.size === 0) {
        logMsg('‚ùå Primero busca los perros', 'error');
        return;
      }

      if (!confirm(`¬øMigrar TODOS los ${todosLosPerros.size} perros a Supabase?`)) {
        return;
      }

      logMsg(`üöÄ Iniciando migraci√≥n de ${todosLosPerros.size} perros...`, 'info');

      const perrosArray = Array.from(todosLosPerros);
      let exitos = 0;
      let fallos = 0;
      let saltados = 0;

      // Resetear progreso
      actualizarProgreso(0, perrosArray.length);

      for (let i = 0; i < perrosArray.length; i++) {
        const perroId = perrosArray[i];
        const chenilId = perrosConChenil[perroId] || null;

        actualizarProgreso(i + 1, perrosArray.length);
        logMsg(`üîÑ [${i+1}/${perrosArray.length}] Migrando ${perroId}...`);

        try {
          // Verificar si ya existe en Supabase
          const { data: existente } = await supabase
            .from('perros')
            .select('id')
            .eq('id', perroId)
            .single();

          if (existente) {
            logMsg(`‚è≠Ô∏è ${perroId} ya existe en Supabase, actualizando...`, 'warning');
            saltados++;
          }

          // Cargar datos del perro desde GitHub
          const perroUrl = `https://raw.githubusercontent.com/pesaher/perros/main/archivos/perros/${encodeURIComponent(perroId)}.json`;
          const perroResp = await fetch(perroUrl);

          if (perroResp.ok) {
            const datosPerro = await perroResp.json();

            // A√±adir chenil_id a los datos si corresponde
            if (chenilId) {
              datosPerro.chenil_id = chenilId;
            }

            // Guardar en Supabase
            const { error } = await supabase
              .from('perros')
              .upsert({
                id: perroId,
                chenil_id: chenilId,
                datos: datosPerro
              }, { onConflict: 'id' });

            if (error) {
              logMsg(`‚ùå ${perroId}: ${error.message}`, 'error');
              fallos++;
            } else {
              logMsg(`‚úÖ ${perroId} ‚Üí ${chenilId || 'sin chenil'}`, 'success');
              exitos++;
            }
          } else {
            logMsg(`‚ö†Ô∏è ${perroId} no encontrado en GitHub`, 'warning');
            fallos++;
          }

          // Peque√±a pausa para no saturar
          await new Promise(resolve => setTimeout(resolve, 100));

        } catch (error) {
          logMsg(`‚ùå Error con ${perroId}: ${error.message}`, 'error');
          fallos++;
        }
      }

      // Mostrar resumen final
      logMsg(`üéâ MIGRACI√ìN COMPLETADA:`, 'success');
      logMsg(`‚úÖ ${exitos} migrados correctamente`, 'success');
      logMsg(`‚è≠Ô∏è ${saltados} ya exist√≠an (actualizados)`, 'warning');
      logMsg(`‚ùå ${fallos} fallos`, fallos > 0 ? 'error' : 'info');
      logMsg(`üìä Total procesados: ${perrosArray.length}`, 'info');

      // Resetear progreso
      actualizarProgreso(0, 100);
    }

    async function migrarSoloHu√©rfanos() {
      if (!supabase || todosLosPerros.size === 0) {
        logMsg('‚ùå Primero busca los perros', 'error');
        return;
      }

      // Filtrar solo perros hu√©rfanos (sin chenil)
      const perrosHu√©rfanos = Array.from(todosLosPerros).filter(
        perroId => !perrosConChenil[perroId]
      );

      if (perrosHu√©rfanos.length === 0) {
        logMsg('‚úÖ No hay perros hu√©rfanos para migrar', 'success');
        return;
      }

      if (!confirm(`¬øMigrar ${perrosHu√©rfanos.length} perros hu√©rfanos a Supabase?`)) {
        return;
      }

      logMsg(`üëª Migrando ${perrosHu√©rfanos.length} perros hu√©rfanos...`, 'info');

      let exitos = 0;
      let fallos = 0;

      actualizarProgreso(0, perrosHu√©rfanos.length);

      for (let i = 0; i < perrosHu√©rfanos.length; i++) {
        const perroId = perrosHu√©rfanos[i];

        actualizarProgreso(i + 1, perrosHu√©rfanos.length);
        logMsg(`üîÑ [${i+1}/${perrosHu√©rfanos.length}] ${perroId}...`);

        try {
          const perroUrl = `https://raw.githubusercontent.com/pesaher/perros/main/archivos/perros/${encodeURIComponent(perroId)}.json`;
          const perroResp = await fetch(perroUrl);

          if (perroResp.ok) {
            const datosPerro = await perroResp.json();

            // Marcar como hu√©rfano (chenil_id = null)
            datosPerro.chenil_id = null;

            const { error } = await supabase
              .from('perros')
              .upsert({
                id: perroId,
                chenil_id: null,
                datos: datosPerro
              }, { onConflict: 'id' });

            if (error) {
              logMsg(`‚ùå ${perroId}: ${error.message}`, 'error');
              fallos++;
            } else {
              logMsg(`‚úÖ ${perroId} (hu√©rfano)`, 'success');
              exitos++;
            }
          }

          await new Promise(resolve => setTimeout(resolve, 100));

        } catch (error) {
          logMsg(`‚ùå ${perroId}: ${error.message}`, 'error');
          fallos++;
        }
      }

      logMsg(`üéâ Hu√©rfanos migrados: ${exitos} OK, ${fallos} fallos`, 'success');
      actualizarProgreso(0, 100);
    }

    async function limpiarTabla() {
      if (!confirm('¬øEST√ÅS ABSOLUTAMENTE SEGURO? Esto borrar√° TODOS los perros de Supabase.')) return;
      if (!confirm('¬øDE VERDAD? No hay vuelta atr√°s.')) return;

      const { error } = await supabase
        .from('perros')
        .delete()
        .neq('id', '');

      if (error) {
        logMsg(`‚ùå Error: ${error.message}`, 'error');
      } else {
        logMsg('üóëÔ∏è Tabla limpiada completamente', 'success');
      }
    }
  </script>
</body>
</html>
